pipeline { 
    agent any 
    tools { 
        jdk 'jdk-17' 
        nodejs 'node-16' 
    } 
    environment { 
        SCANNER_HOME = tool 'sonar-scanner' 
    } 
    stages { 
        stage('clean workspace') { 
            steps { 
                cleanWs() 
            } 
        } 
        stage('Checkout from Git') { 
            steps { 
                git branch: 'main', url: 'https://github.com/dehnis-io/crypgo.git' 
            } 
        } 
        stage("Sonarqube Analysis") { 
            steps { 
                withSonarQubeEnv('SonarQube-Server') { 
                    sh '''$SCANNER_HOME/bin/sonar-scanner -Dsonar.projectName=crypgo-cicd \ 
                    -Dsonar.projectKey=crypgo-cicd''' 
                } 
            } 
        } 
        stage("Quality Gate") { 
            steps { 
                script { 
                    waitForQualityGate abortPipeline: false, credentialsId: 'SonarQube-token' 
                } 
            } 
        } 
        stage('Install Dependencies') { 
            steps { 
                sh "npm install" 
            } 
        } 
        stage('TRIVY FS SCAN') { 
             steps { 
                 sh "trivy fs . > trivyfs.txt" 
             } 
         } 
         stage("Docker Build & Push"){ 
             steps{ 
                 script{ 
                   withDockerRegistry(credentialsId: 'dockerhub', toolName: 'docker'){    
                      sh """ 
                            docker build -t techadvocate247/crypgo:latest . 
                            docker push techadvocate247/crypgo:latest 
                        """ 
                    } 
                } 
            } 
        } 
        stage("TRIVY Image Scan"){ 
            steps{ 
                sh "trivy image techadvocate247/crypgo:latest > trivyimage.txt"  
            } 
        } 
        stage('Deploy to Kubernets'){ 
            steps{ 
                script{ 
                    dir('kubernetes') { 
                      withKubeConfig(caCertificate: '', clusterName: '', contextName: '', credentialsId: 'kubernetes', namespace: '', restrictKubeConfigAccess: false, serverUrl: '') { 
                      sh 'kubectl delete --all pods' 
                      sh 'kubectl apply -f deployment.yml' 
                      sh 'kubectl apply -f service.yml' 
                      }    
                    } 
                } 
            } 
        } 
    } 

    post { 
     always { 
        emailext attachLog: true, 
            subject: "'${currentBuild.result}'", 
            body: "Project: ${env.JOB_NAME}<br/>" + 
                "Build Number: ${env.BUILD_NUMBER}<br/>" + 
                "URL: ${env.BUILD_URL}<br/>", 
            to: 'tech.advocate247@gmail.com',                               
            attachmentsPattern: 'trivyfs.txt,trivyimage.txt' 
        } 
    } 
} 